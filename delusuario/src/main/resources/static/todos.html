<!DOCTYPE html>

<html lang="es">
<head>
  <title>Lista de productos</title>
  <link rel="stylesheet" href="todos.css">
</head>
<body>
<!-- Page Content  -->
<div id="content" class="p-4 p-md-5 pt-5">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2">
        <div class="contenido">
          <div class="imagen">
            <img src="https://lh3.googleusercontent.com/JRsGJQgTpxmpaG0av_1nHtiXjIw72bbv2hn5PavNm0jAUGxaLsYT3JQQHF_mMKN_-z3zrOv2V63c63ITiwdLuwlmCLnS8iT2pdy4KCIwXJbf8TaKFPFqxVYGjar8m93hbptY6VJe-62b94-hCFSKY3WkOtAHIeGIim3xd5tyCQcoAL2RmFXJIaE1NxGZbpKFblUKiXAtIAIKDIZX0oo04h-vJz4VOR3jnVQEehK1IHwYWiWKbuhUWBY_rpM5IE5_Hno8s2fqfFCXQ1m6KnOlyMLfhj8qXWBnHm_H1R97ONBfF2eh0fC-tb9tzVGOPPBmQHtR6FuvQtJnvwA-yA6OFR8AytQKTPW5Wc429A3Nf8ANjeNnde7zySZcaaVAljRVxh6nF7awFun5P7JXNHHpKzMzFvSwkzYg3lKLnwz81YynHSEBQgJjlWtD0QiVtcMjy5XDzsqso7IBRG23aUCZpV0VGKBI_5j1R4q_1sPqDooNzb6hryXFIqiTEL0lY55m75_y3pOoG-SJRhG_TCFSMUbLYWMOzOVUxbx3ogmpFbKGUYurR8iVudyFu6cfRW1Du151eCW598YB-2srfn1cjDTvdKE1Dfwa1xQ0LHTX-ZMrs9jA0kuAnjGykdTxqft2SeEC4vHF0sEgVwhZP2ds14jXr8bxKz9T7mShKBAmC_-7mzwixCVepzP6u6LDUC_D7nJrPDb2h8VG0EGTi1rp732WJbR5q5Q-yLvCb-nrfcoKPh5uWD8_PQ6-WRPpCaL_VPWEYin2gPbmIcQRtT_0aNpoD3yLi-GPUUyBEMQlcHJqs49BbYtUKUAOrQyTM0duWvOo3bQZgaaGzTUnbkrDAjOZDC2KxbZyCpl3b-m2hxcmASzGZx6dkUnzY9OD5khFa1ADxvk-yTawduMMwZTBI7-xgEGrjlQ9dG1sYz6Uc4lB=w500-h500-s-no?authuser=0" alt="Imagen" alt="Imagen" />
          </div>
          <div class="texto">
            <h1>Usuario</h1>
            <p>Este es tu listado de productos, desliza hacia abajo para visualizarlos, enn cantidad a vender puedes colocar la cantidad del producto que te pida el cliente y luego agregarlo a la venta. Finalizas la venta con el boton vender, una vez vendido tu venta se almacenara en el historial de ventas</p>
            <hr>
            <br><br><br>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<h1>Lista de productos</h1>
<table>
  <thead>
  <tr>
    <th>ID</th>
    <th>Nombre</th>
    <th>Precio</th>
    <th>Cantidad a vender</th>
    <th></th>
  </tr>
  </thead>
  <tbody id="product-table-body"></tbody>
</table>

<button id="sell-button" onclick="venderProductos()">Vender</button>

<script>
  // Obtener los datos de los productos mediante una petición HTTP
  fetch('http://localhost:8080/productos/todos')
          .then(response => response.json())
          .then(productos => {
            // Ordenar los productos por ID ascendente
            productos.sort((a, b) => a.id_producto - b.id_producto);

            const tbody = document.getElementById('product-table-body');
            productos.forEach(producto => {
              const row = document.createElement('tr');
              row.innerHTML = `
            <td>${producto.id_producto}</td>
            <td>${producto.nombre_producto}</td>
            <td>${producto.precio_producto}</td>
            <td><input type="number" id="cantidad-${producto.id_producto}" min="0" value="0"></td>
            <td><button class="sell-button" onclick="agregarVenta(${producto.id_producto})">Agregar a la venta</button></td>
          `;
              tbody.appendChild(row);
            });
          })
          .catch(error => console.error(error));

  let ventaItems = [];

  function agregarVenta(idProducto) {
    const cantidad = document.getElementById(`cantidad-${idProducto}`).value;
    ventaItems.push({ id_producto: { id_producto: idProducto }, cantidad_venta: parseInt(cantidad) });
  }

  function venderProductos() {
    fetch('http://localhost:8080/productos/vender', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(ventaItems)
    })
            .then(response => {
              if (response.ok) {
                console.log('Productos vendidos exitosamente');
              } else if (response.status === 404) {
                console.error('Producto no encontrado');
              } else if (response.status === 400) {
                response.text().then(errorMessage => console.error(errorMessage));
              } else {
                console.error('Error al vender los productos');
              }
            })
            .catch(error => console.error('Error en la petición:', error));

    // Reiniciar la lista de ventaItems
    ventaItems = [];
  }
</script>
</body>
</html>