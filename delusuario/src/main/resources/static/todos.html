<!DOCTYPE html>
<html>
<head>
  <title>Lista de productos</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f2f2f2;
    }

    .sell-button {
      padding: 4px 8px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
<h1>Lista de productos</h1>
<table>
  <thead>
  <tr>
    <th>ID</th>
    <th>Nombre</th>
    <th>Precio</th>
    <th>Cantidad a vender</th>
    <th></th>
  </tr>
  </thead>
  <tbody id="product-table-body"></tbody>
</table>

<button id="sell-button" onclick="venderProductos()">Vender</button>

<script>
  // Obtener los datos de los productos mediante una petición HTTP
  fetch('http://localhost:8080/productos/todos')
          .then(response => response.json())
          .then(productos => {
            // Ordenar los productos por ID ascendente
            productos.sort((a, b) => a.id_producto - b.id_producto);

            const tbody = document.getElementById('product-table-body');
            productos.forEach(producto => {
              const row = document.createElement('tr');
              row.innerHTML = `
            <td>${producto.id_producto}</td>
            <td>${producto.nombre_producto}</td>
            <td>${producto.precio_producto}</td>
            <td><input type="number" id="cantidad-${producto.id_producto}" min="0" value="0"></td>
            <td><button class="sell-button" onclick="agregarVenta(${producto.id_producto})">Agregar a la venta</button></td>
          `;
              tbody.appendChild(row);
            });
          })
          .catch(error => console.error(error));

  let ventaItems = [];

  function agregarVenta(idProducto) {
    const cantidad = document.getElementById(`cantidad-${idProducto}`).value;
    ventaItems.push({ id_producto: { id_producto: idProducto }, cantidad_venta: parseInt(cantidad) });
  }

  function venderProductos() {
    fetch('http://localhost:8080/productos/vender', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(ventaItems)
    })
            .then(response => {
              if (response.ok) {
                console.log('Productos vendidos exitosamente');
              } else if (response.status === 404) {
                console.error('Producto no encontrado');
              } else if (response.status === 400) {
                response.text().then(errorMessage => console.error(errorMessage));
              } else {
                console.error('Error al vender los productos');
              }
            })
            .catch(error => console.error('Error en la petición:', error));

    // Reiniciar la lista de ventaItems
    ventaItems = [];
  }
</script>
</body>
</html>
